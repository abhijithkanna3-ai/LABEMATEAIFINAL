{% extends "base.html" %}

{% block title %}Fluid Mechanics Calculator - Pitot Tube Experiment{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="mb-1">
                <i class="fas fa-tachometer-alt me-2 text-primary"></i>
                Fluid Mechanics: Pitot Tube Experiment
            </h1>
            <p class="text-muted">Determination of Velocity Coefficient (Cᵥ)</p>
            <div class="mt-3">
                <a href="{{ url_for('calculator') }}?type=chemistry" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-flask me-1"></i>Switch to Chemistry Calculator
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Input Section -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-edit me-2"></i>Input Data
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Number of Readings -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Number of Readings</label>
                        <div class="input-group">
                            <input type="number" id="numReadings" class="form-control" value="5" min="1" max="20">
                            <button class="btn btn-outline-secondary" onclick="generateInputFields()">
                                <i class="fas fa-sync me-1"></i>Update Fields
                            </button>
                        </div>
                    </div>

                    <!-- Manometer Readings Table -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Manometer Readings</label>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th rowspan="2" class="text-center align-middle">Reading</th>
                                        <th colspan="2" class="text-center">Orifice (mm)</th>
                                        <th colspan="2" class="text-center">Pitot Tube (mm)</th>
                                    </tr>
                                    <tr>
                                        <th class="text-center">l₁o</th>
                                        <th class="text-center">l₂o</th>
                                        <th class="text-center">l₁p</th>
                                        <th class="text-center">l₂p</th>
                                    </tr>
                                </thead>
                                <tbody id="readingsTableBody">
                                    <!-- Dynamic rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Graph Selection -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Graph Parameters</label>
                        <div class="row">
                            <div class="col-6">
                                <label class="small">X-axis</label>
                                <select id="graphX" class="form-select form-select-sm">
                                    <option value="V0" selected>V₀ (Orifice Velocity)</option>
                                    <option value="Vp">Vₚ (Pitot Velocity)</option>
                                    <option value="Ha0">Ha₀ (Orifice Head)</option>
                                    <option value="Hap">Haₚ (Pitot Head)</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="small">Y-axis</label>
                                <select id="graphY" class="form-select form-select-sm">
                                    <option value="Vp" selected>Vₚ (Pitot Velocity)</option>
                                    <option value="V0">V₀ (Orifice Velocity)</option>
                                    <option value="Ha0">Ha₀ (Orifice Head)</option>
                                    <option value="Hap">Haₚ (Pitot Head)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Constants (Optional) -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="useCustomConstants">
                            <label class="form-check-label" for="useCustomConstants">
                                Use Custom Constants
                            </label>
                        </div>
                        <div id="customConstantsDiv" style="display: none;" class="mt-3">
                            <div class="row g-2">
                                <div class="col-4">
                                    <label class="small">Cd₀</label>
                                    <input type="number" id="Cd0" class="form-control form-control-sm" value="0.62" step="0.01">
                                </div>
                                <div class="col-4">
                                    <label class="small">d₀ (mm)</label>
                                    <input type="number" id="d0" class="form-control form-control-sm" value="30" step="1">
                                </div>
                                <div class="col-4">
                                    <label class="small">D (mm)</label>
                                    <input type="number" id="D" class="form-control form-control-sm" value="35" step="1">
                                </div>
                                <div class="col-4">
                                    <label class="small">ρₘ (kg/m³)</label>
                                    <input type="number" id="rho_m" class="form-control form-control-sm" value="1000" step="1">
                                </div>
                                <div class="col-4">
                                    <label class="small">ρ (kg/m³)</label>
                                    <input type="number" id="rho" class="form-control form-control-sm" value="1.2" step="0.1">
                                </div>
                                <div class="col-4">
                                    <label class="small">g (m/s²)</label>
                                    <input type="number" id="g" class="form-control form-control-sm" value="9.81" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calculate Button -->
                    <button class="btn btn-primary btn-lg w-100" onclick="calculateFluidMechanics()">
                        <i class="fas fa-calculator me-2"></i>Calculate & Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Constants & Info Section -->
        <div class="col-lg-6">
            <!-- Standard Constants Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2 text-info"></i>Standard Constants
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row small">
                        <div class="col-6">
                            <p class="mb-1"><strong>Cd₀:</strong> 0.62</p>
                            <p class="mb-1"><strong>d₀:</strong> 30 mm</p>
                            <p class="mb-1"><strong>D:</strong> 35 mm</p>
                            <p class="mb-1"><strong>Ao:</strong> 7.0686 × 10⁻⁴ m²</p>
                            <p class="mb-1"><strong>A:</strong> 9.6211 × 10⁻⁴ m²</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>ρₘ:</strong> 1000 kg/m³</p>
                            <p class="mb-1"><strong>ρ:</strong> 1.2 kg/m³</p>
                            <p class="mb-1"><strong>g:</strong> 9.81 m/s²</p>
                            <p class="mb-1"><strong>sin(25°):</strong> 0.422</p>
                            <p class="mb-1"><strong>sin(15°):</strong> 0.258</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulae Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-square-root-alt me-2 text-warning"></i>Formulae
                    </h5>
                </div>
                <div class="card-body small">
                    <ol class="mb-0">
                        <li class="mb-2">Ha₀ = [(l₂o - l₁o) × sin25° × ρₘ] / (100 × ρ)</li>
                        <li class="mb-2">V₀ = [Cd₀ × Ao × √(2 × g × Ha₀)] / A</li>
                        <li class="mb-2">Haₚ = [(l₂p - l₁p) × sin15° × ρₘ] / (100 × ρ)</li>
                        <li class="mb-2">Vₚ = √(2 × g × Haₚ)</li>
                        <li>Cᵥ = V₀ / Vₚ</li>
                    </ol>
                </div>
            </div>

            <!-- Instructions Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2 text-success"></i>Instructions
                    </h5>
                </div>
                <div class="card-body small">
                    <ol class="mb-0">
                        <li>Enter the number of readings and click "Update Fields"</li>
                        <li>Input all manometer readings (l₁o, l₂o, l₁p, l₂p) in millimeters</li>
                        <li>Select the parameters for the graph (X and Y axes)</li>
                        <li>Optionally, modify constants if needed</li>
                        <li>Click "Calculate & Generate Report" to process</li>
                        <li>View results table, model calculation, graph, and download report</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section (Initially Hidden) -->
    <div id="resultsSection" style="display: none;" class="mt-4">
        <div class="row">
            <div class="col-12">
                <!-- Results Table -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>Calculation Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="resultsTable" class="table-responsive"></div>
                        <div id="summaryDiv" class="alert alert-success mt-3"></div>
                    </div>
                </div>

                <!-- Model Calculation -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list-ol me-2"></i>Model Calculation (Reading 1)
                        </h5>
                    </div>
                    <div class="card-body">
                        <pre id="modelCalculation" class="bg-light p-3 rounded"></pre>
                    </div>
                </div>

                <!-- Graph -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Graph
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <img id="graphImage" class="img-fluid" alt="Experiment Graph">
                    </div>
                </div>

                <!-- Download Options -->
                <div class="text-center">
                    <button class="btn btn-primary btn-lg" onclick="downloadPDF()">
                        <i class="fas fa-file-pdf me-2"></i>Download PDF Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Processing experiment data...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentResults = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    generateInputFields();
    
    // Toggle custom constants
    document.getElementById('useCustomConstants').addEventListener('change', function() {
        document.getElementById('customConstantsDiv').style.display = this.checked ? 'block' : 'none';
    });
});

function generateInputFields() {
    const numReadings = parseInt(document.getElementById('numReadings').value);
    const tbody = document.getElementById('readingsTableBody');
    tbody.innerHTML = '';
    
    for (let i = 1; i <= numReadings; i++) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="text-center fw-bold">${i}</td>
            <td><input type="number" class="form-control form-control-sm reading-input" id="l1o_${i}" step="0.1"></td>
            <td><input type="number" class="form-control form-control-sm reading-input" id="l2o_${i}" step="0.1"></td>
            <td><input type="number" class="form-control form-control-sm reading-input" id="l1p_${i}" step="0.1"></td>
            <td><input type="number" class="form-control form-control-sm reading-input" id="l2p_${i}" step="0.1"></td>
        `;
        tbody.appendChild(row);
    }
}

function collectReadings() {
    const numReadings = parseInt(document.getElementById('numReadings').value);
    const orificeReadings = [];
    const pitotReadings = [];
    
    for (let i = 1; i <= numReadings; i++) {
        const l1o = parseFloat(document.getElementById(`l1o_${i}`).value);
        const l2o = parseFloat(document.getElementById(`l2o_${i}`).value);
        const l1p = parseFloat(document.getElementById(`l1p_${i}`).value);
        const l2p = parseFloat(document.getElementById(`l2p_${i}`).value);
        
        if (isNaN(l1o) || isNaN(l2o) || isNaN(l1p) || isNaN(l2p)) {
            return null; // Invalid input
        }
        
        orificeReadings.push([l1o, l2o]);
        pitotReadings.push([l1p, l2p]);
    }
    
    return { orificeReadings, pitotReadings };
}

function collectConstants() {
    if (!document.getElementById('useCustomConstants').checked) {
        return null; // Use defaults
    }
    
    return {
        'Cd0': parseFloat(document.getElementById('Cd0').value),
        'd0': parseFloat(document.getElementById('d0').value),
        'D': parseFloat(document.getElementById('D').value),
        'rho_m': parseFloat(document.getElementById('rho_m').value),
        'rho': parseFloat(document.getElementById('rho').value),
        'g': parseFloat(document.getElementById('g').value),
        'sin25': 0.422,
        'sin15': 0.258
    };
}

function calculateFluidMechanics() {
    // Collect readings
    const readings = collectReadings();
    if (!readings) {
        alert('Please fill in all manometer readings');
        return;
    }
    
    // Collect graph parameters
    const graphParams = [
        document.getElementById('graphX').value,
        document.getElementById('graphY').value
    ];
    
    // Collect custom constants if any
    const constants = collectConstants();
    
    // Show loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Send data to server
    fetch('/fluid_calculate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            orifice_readings: readings.orificeReadings,
            pitot_readings: readings.pitotReadings,
            graph_params: graphParams,
            constants: constants
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        
        if (data.success) {
            displayResults(data);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        loadingModal.hide();
        alert('Error processing data: ' + error);
    });
}

function displayResults(data) {
    currentResults = data;
    
    // Build results table
    let tableHtml = `
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Reading</th>
                    <th>l₁o (mm)</th>
                    <th>l₂o (mm)</th>
                    <th>l₁p (mm)</th>
                    <th>l₂p (mm)</th>
                    <th>Ha₀ (m)</th>
                    <th>V₀ (m/s)</th>
                    <th>Haₚ (m)</th>
                    <th>Vₚ (m/s)</th>
                    <th>Cᵥ</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    data.results.forEach((result, index) => {
        tableHtml += `
            <tr>
                <td class="fw-bold">${index + 1}</td>
                <td>${result.l1o.toFixed(1)}</td>
                <td>${result.l2o.toFixed(1)}</td>
                <td>${result.l1p.toFixed(1)}</td>
                <td>${result.l2p.toFixed(1)}</td>
                <td>${result.Ha0.toFixed(4)}</td>
                <td>${result.V0.toFixed(4)}</td>
                <td>${result.Hap.toFixed(4)}</td>
                <td>${result.Vp.toFixed(4)}</td>
                <td class="fw-bold">${result.Cv.toFixed(4)}</td>
            </tr>
        `;
    });
    
    tableHtml += '</tbody></table>';
    
    // Display results
    document.getElementById('resultsTable').innerHTML = tableHtml;
    document.getElementById('summaryDiv').innerHTML = `
        <h5 class="mb-0">Mean Velocity Coefficient (Cᵥ): <strong>${data.mean_cv.toFixed(4)}</strong></h5>
    `;
    document.getElementById('modelCalculation').textContent = data.model_calculation;
    document.getElementById('graphImage').src = 'data:image/png;base64,' + data.graph_base64;
    
    // Show results section
    document.getElementById('resultsSection').style.display = 'block';
    
    // Scroll to results
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

function downloadPDF() {
    if (!currentResults || !currentResults.pdf_base64) {
        alert('No PDF data available. Please run the calculation first.');
        return;
    }
    
    // Send PDF data to server for download
    fetch('/download_pdf', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            pdf_base64: currentResults.pdf_base64
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('Failed to generate PDF');
        }
    })
    .then(blob => {
        // Create download link
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const now = new Date();
        const indianDate = now.getDate().toString().padStart(2, '0') + 
                          (now.getMonth() + 1).toString().padStart(2, '0') + 
                          now.getFullYear() + '_' +
                          now.getHours().toString().padStart(2, '0') +
                          now.getMinutes().toString().padStart(2, '0') +
                          now.getSeconds().toString().padStart(2, '0');
        a.download = `pitot_tube_report_${indianDate}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show success message
        if (window.LabMateAI && window.LabMateAI.showToast) {
            window.LabMateAI.showToast('PDF Report downloaded successfully!', 'success');
        }
    })
    .catch(error => {
        console.error('Error downloading PDF:', error);
        alert('Error downloading PDF: ' + error.message);
    });
}
</script>
{% endblock %}